<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>摸鱼日记 🐾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
            background-color: #FFF9E6; /* 非常浅的奶油黄 */
            color: #5D5C61; /* 深灰，略带暖调 */
        }
        .container-app {
            max-width: 768px; 
            margin: 1rem auto; 
            padding: 1rem;
        }
        .card {
            background-color: white;
            border-radius: 1rem; 
            box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.08), 0 3px 7px -3px rgba(0, 0, 0, 0.06); 
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .input-field, .select-field {
            border: 1px solid #E0E0E0; 
            padding: 0.75rem 1rem;
            border-radius: 0.75rem; 
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #FDFDFD;
        }
        .select-field-nav { 
            border: 1px solid #FFB6C1; 
            padding: 0.6rem 1rem;
            border-radius: 0.75rem;
            background-color: white;
            color: #FF69B4; 
            font-weight: 500;
        }
        .select-field-nav:focus {
            border-color: #FF69B4;
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.3);
            outline: none;
        }
        .input-field:focus, .select-field:focus {
            border-color: #89CFF0; 
            box-shadow: 0 0 0 3px rgba(137, 207, 240, 0.3);
            outline: none;
        }
        .btn {
            padding: 0.85rem 1.75rem; 
            border-radius: 0.75rem; 
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn:active {
            transform: translateY(2px) scale(0.98);
        }
        .btn-primary { background-color: #89CFF0; color: white; } 
        .btn-primary:hover { background-color: #7CB9E8; box-shadow: 0 2px 8px rgba(137, 207, 240, 0.5); }
        .btn-danger { background-color: #FFB6C1; color: #5D5C61; } 
        .btn-danger:hover { background-color: #FFA07A; box-shadow: 0 2px 8px rgba(255, 182, 193, 0.5); }
        .btn-success { background-color: #90EE90; color: #5D5C61; } 
        .btn-success:hover { background-color: #7CCD7C; box-shadow: 0 2px 8px rgba(144, 238, 144, 0.5); }
        
        .stats-value { font-size: 1.35rem; font-weight: 600; color: #4A4A4A; }
        .stats-label { font-size: 0.9rem; color: #757575; }
        .clickable-stat:hover .stats-label, .clickable-stat:hover .stats-value {
            color: #FF69B4; 
        }
        .timer-display-lg {
            font-size: 3.5rem; font-weight: 700; color: #89CFF0; text-align: center;
            margin: 1.5rem 0; padding: 1.5rem; background-color: #F0F8FF; 
            border-radius: 1rem; border: 2px dashed #B0E0E6; 
        }
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background-color: rgba(60, 60, 60, 0.9); color: white; padding: 1rem 1.75rem;
            border-radius: 0.75rem; z-index: 1000; opacity: 0;
            transition: opacity 0.5s ease, transform 0.3s ease; font-size: 1rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.show.initial { transform: translateX(-50%) translateY(20px); }
        .icon-sm { width: 1.35rem; height: 1.35rem; margin-right: 0.6rem; }
        .hidden { display: none !important; } 
        
        .page-content.active {
            display: block;
        }

        .chart-bar {
            background-color: #FFDAB9; 
            border-radius: 0.35rem;
            text-align: right;
            padding-right: 0.5rem;
            color: #8B4513; 
            font-size: 0.8rem;
            line-height: 1.5rem; 
            transition: width 0.5s ease-in-out;
        }
        .chart-label {
            width: 3rem; 
            text-align: right;
            padding-right: 0.5rem;
        }
        .chart-container {
            flex-grow: 1;
            background-color: #FFF5EE; 
            border-radius: 0.5rem;
            height: 1.5rem; 
            margin-right: 0.5rem;
            margin-left: 0.25rem;
        }

        .achievement-card {
            padding: 1.5rem;
            background: linear-gradient(135deg, #FFF0F5 0%, #E6E6FA 100%); 
            border-radius: 1rem;
            text-align: center; 
        }
        .achievement-icon {
            font-size: 3.5rem; 
            color: #FFD700; 
            margin-bottom: 0.75rem; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .achievement-title {
            font-size: 1.75rem; 
            font-weight: 700;
            color: #6A0DAD; 
            margin-bottom: 0.25rem;
        }
        .total-slacking-display { 
            font-size: 0.9rem;
            color: #4B0082; 
            margin-bottom: 0.75rem;
        }
        .progress-bar-container {
            width: 90%; 
            margin-left: auto;
            margin-right: auto;
            background-color: #E6E6FA; 
            border-radius: 1rem; 
            overflow: hidden;
            height: 1.5rem; 
            margin-top: 0.75rem;
            border: 1px solid #D8BFD8; 
        }
        .progress-bar {
            background: linear-gradient(to right, #FFB6C1, #FFA07A); 
            height: 100%;
            text-align: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            line-height: 1.5rem;
            transition: width 0.5s ease-in-out;
            border-radius: 1rem 0 0 1rem; 
        }
        .progress-bar.full {
             border-radius: 1rem; 
        }
        .next-achievement-text { 
            font-size: 0.85rem;
            color: #800080; 
            margin-top: 0.5rem;
        }
        .app-title {
            font-size: 2.5rem; 
            font-weight: 700;
            color: #FF69B4; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

    </style>
</head>
<body>
    <div class="container-app">
        <header class="mb-6 py-4 text-center">
            <h1 class="app-title">摸鱼日记 🐾</h1>
        </header>

        <div class="mb-6 text-center">
            <label for="pageSelect" class="mr-2 text-lg font-medium text-pink-500">传送门:</label>
            <select id="pageSelect" class="select-field-nav inline-block w-auto sm:w-60">
                <option value="mainView">🐾 我的主页</option>
                <option value="settingsView">⚙️ 个性化设置</option>
                <option value="yearlyView">📅 年度回顾</option>
            </select>
        </div>

        <div id="mainView" class="page-content active">
            <div class="card achievement-card-wrapper">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 text-center">我的闪亮称号 ✨</h2>
                <div id="achievementDisplay" class="achievement-card">
                    <i id="achievementIcon" class="fas fa-award achievement-icon"></i>
                    <p id="achievementName" class="achievement-title">摸鱼萌新</p>
                    <p id="totalSlackingHoursDisplay" class="total-slacking-display">总摸鱼: 0.00 小时</p>
                    <div class="progress-bar-container w-full">
                        <div id="achievementProgressBar" class="progress-bar" style="width: 0%;">0%</div>
                    </div>
                    <p id="nextAchievementText" class="next-achievement-text">距离下一个称号还有很远...</p>
                </div>
            </div>

            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-fish text-orange-400 mr-2"></i>开始摸鱼啦! 🚀</h2>
                <p id="statusText" class="text-center text-gray-500 mb-2 text-lg">当前状态：元气满满 💪</p>
                <div id="timerDisplay" class="timer-display-lg">00:00:00</div>
                <div class="space-y-3">
                    <div>
                        <label for="slackingTypeSelect" class="block text-sm font-medium text-gray-600 mb-1">摸鱼姿势 🧘:</label>
                        <select id="slackingTypeSelect" class="select-field"></select>
                    </div>
                    <div id="customSlackingTypeDiv" class="hidden">
                        <label for="customSlackingTypeInput" class="block text-sm font-medium text-gray-600 mb-1">独创摸鱼法:</label>
                        <input type="text" id="customSlackingTypeInput" class="input-field" placeholder="快来命名你的摸鱼大法！">
                    </div>
                    </div>
                <button id="toggleButton" class="btn btn-primary w-full mt-4">
                    <i class="fas fa-paper-plane icon-sm"></i>
                    开启摸鱼之旅!
                </button>
            </div>

            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center"><i class="fas fa-chart-pie text-purple-500 mr-2"></i>本月数据看板 📈</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"> 
                    <div id="monthlySalaryConfigLink" class="p-4 bg-sky-50 rounded-xl cursor-pointer clickable-stat"><p class="stats-label">月薪配置 (点此设置)</p><p id="summaryMonthlySalary" class="stats-value">未设置</p></div>
                    <div class="p-4 bg-emerald-50 rounded-xl"><p class="stats-label">每日有效工作时间</p><p id="summaryDailyWorkHours" class="stats-value">未设置</p></div>
                    <div class="p-4 bg-amber-50 rounded-xl"><p class="stats-label">本月工作日</p><p id="summaryWorkingDays" class="stats-value">0 天</p></div>
                    <div class="p-4 bg-rose-50 rounded-xl"><p class="stats-label">本月计划总工时</p><p id="summaryTotalScheduledHours" class="stats-value">0 小时</p></div>
                    <div class="p-4 bg-violet-50 rounded-xl"><p class="stats-label">本月总摸鱼</p><p id="summaryTotalSlackingTime" class="stats-value">0 小时</p></div>
                    <div class="p-4 bg-cyan-50 rounded-xl border border-cyan-200"><p class="stats-label text-cyan-700">距发薪日 📅</p><p id="summaryDaysUntilPayday" class="stats-value text-cyan-600">-- 天</p></div>
                    <div class="p-5 bg-orange-100 rounded-xl border-2 border-orange-300 col-span-1 sm:col-span-2 lg:col-span-3 text-center">
                        <p class="stats-label text-orange-700 text-lg">摸到的工资 💸</p>
                        <p id="summarySlackedSalary" class="stats-value text-orange-600 text-3xl mt-1">¥ 0.00</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-700 flex items-center"><i class="fas fa-shoe-prints text-brown-500 mr-2"></i>摸鱼足迹 🐾 (本月)</h2>
                    <button id="clearHistoryButton" class="text-sm text-pink-500 hover:text-pink-700 font-medium flex items-center">
                        <i class="fas fa-trash-alt icon-sm"></i>
                        清空所有历史
                    </button>
                </div>
                <div id="historyList" class="space-y-3 max-h-96 overflow-y-auto pr-2"> 
                    <p class="text-gray-500 text-center py-4" id="noHistoryText">还没有摸鱼记录哦，快来开启摸鱼之旅吧！💖</p>
                </div>
            </div>
        </div>

        <div id="settingsView" class="page-content hidden">
            <div class="card"> <h2 class="text-2xl font-semibold text-gray-700 mb-6 flex items-center"><i class="fas fa-sliders-h text-pink-500 mr-3"></i>个性化设置 🛠️</h2>
                <div class="space-y-5">
                    <div>
                        <label for="settingsMonthlySalary" class="block text-sm font-medium text-gray-600 mb-1">月薪 (元) 💰:</label>
                        <input type="number" id="settingsMonthlySalary" class="input-field" placeholder="例如: 10000">
                    </div>
                    <div>
                        <label for="settingsWorkStartTime" class="block text-sm font-medium text-gray-600 mb-1">上班打卡 ☀️:</label>
                        <input type="time" id="settingsWorkStartTime" class="input-field">
                    </div>
                    <div>
                        <label for="settingsWorkEndTime" class="block text-sm font-medium text-gray-600 mb-1">下班打卡 🌙:</label>
                        <input type="time" id="settingsWorkEndTime" class="input-field">
                    </div>
                    <div>
                        <label for="settingsLunchBreakMinutes" class="block text-sm font-medium text-gray-600 mb-1">午休时长 (分钟) 🍱:</label>
                        <input type="number" id="settingsLunchBreakMinutes" class="input-field" placeholder="例如: 60">
                    </div>
                    <div>
                        <label for="settingsPayday" class="block text-sm font-medium text-gray-600 mb-1">发薪日 (每月几号) 🗓️:</label>
                        <input type="number" id="settingsPayday" class="input-field" placeholder="例如: 10" min="1" max="31">
                    </div>
                    <button id="saveSettingsButtonPage" class="btn btn-success w-full mt-3">
                        <i class="fas fa-check-circle icon-sm"></i>
                        保存配置
                    </button>
                </div>
            </div>
        </div>


        <div id="yearlyView" class="page-content hidden">
            <div class="card"> <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-3 sm:mb-0 flex items-center"><i class="fas fa-calendar-check text-teal-500 mr-2"></i>年度回顾 🗓️</h2>
                    <div>
                        <label for="yearSelect" class="mr-2 text-sm font-medium text-gray-600">选择年份:</label>
                        <select id="yearSelect" class="select-field inline-block w-auto sm:w-40"></select>
                    </div>
                </div>

                <div id="yearlyStatsContainer" class="hidden">
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mb-6"> <div class="p-4 bg-purple-100 rounded-xl border border-purple-200">
                            <p class="stats-label text-purple-700">年度总摸鱼时长</p>
                            <p id="yearlyTotalSlackingTime" class="stats-value text-purple-600">0 小时</p>
                        </div>
                        <div class="p-4 bg-pink-100 rounded-xl border border-pink-200">
                            <p class="stats-label text-pink-700">年度摸鱼天数</p>
                            <p id="yearlySlackingDays" class="stats-value text-pink-600">0 天</p>
                        </div>
                        <div class="p-4 bg-yellow-100 rounded-xl border border-yellow-200">
                            <p class="stats-label text-yellow-700">年度最爱摸鱼姿势</p>
                            <p id="yearlyMostCommonType" class="stats-value text-yellow-600">-</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">各月份摸鱼时长 (小时) 📊</h3>
                    <div id="monthlyBreakdownChart" class="space-y-2 p-4 bg-orange-50 rounded-xl">
                        <p id="noYearlyDataText" class="text-gray-500 text-center py-3">该年份还没有摸鱼数据哦~</p>
                    </div>
                </div>
                 <p id="noYearSelectedText" class="text-gray-500 text-center mt-4 py-3">请先选择一个年份查看你的摸鱼成就吧！✨</p>
            </div>
        </div>
    </div>

    <div id="toastMessage" class="toast"></div>

    <script>
        // --- DOM Elements ---
        const pageSelect = document.getElementById('pageSelect');
        const mainView = document.getElementById('mainView');
        const settingsView = document.getElementById('settingsView');
        const yearlyView = document.getElementById('yearlyView');
        const allPageContents = [mainView, settingsView, yearlyView];

        const monthlySalaryInput = document.getElementById('settingsMonthlySalary'); 
        const workStartTimeInput = document.getElementById('settingsWorkStartTime'); 
        const workEndTimeInput = document.getElementById('settingsWorkEndTime');     
        const lunchBreakMinutesInput = document.getElementById('settingsLunchBreakMinutes'); 
        const settingsPaydayInput = document.getElementById('settingsPayday'); 
        const saveSettingsButtonPage = document.getElementById('saveSettingsButtonPage'); 

        const statusText = document.getElementById('statusText');
        const timerDisplay = document.getElementById('timerDisplay');
        const slackingTypeSelect = document.getElementById('slackingTypeSelect');
        const customSlackingTypeDiv = document.getElementById('customSlackingTypeDiv');
        const customSlackingTypeInput = document.getElementById('customSlackingTypeInput');
        // const activityNotesInput = document.getElementById('activityNotesInput'); // Removed
        
        const toggleButton = document.getElementById('toggleButton');
        
        const monthlySalaryConfigLink = document.getElementById('monthlySalaryConfigLink');
        const summaryMonthlySalary = document.getElementById('summaryMonthlySalary');
        const summaryDailyWorkHours = document.getElementById('summaryDailyWorkHours');
        const summaryWorkingDays = document.getElementById('summaryWorkingDays');
        const summaryTotalScheduledHours = document.getElementById('summaryTotalScheduledHours');
        const summaryTotalSlackingTime = document.getElementById('summaryTotalSlackingTime');
        const summaryDaysUntilPayday = document.getElementById('summaryDaysUntilPayday'); 
        const summarySlackedSalary = document.getElementById('summarySlackedSalary'); 

        const historyList = document.getElementById('historyList');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const noHistoryText = document.getElementById('noHistoryText');
        
        const toastMessage = document.getElementById('toastMessage');

        const yearSelectElement = document.getElementById('yearSelect'); 
        const yearlyStatsContainer = document.getElementById('yearlyStatsContainer');
        const yearlyTotalSlackingTime = document.getElementById('yearlyTotalSlackingTime');
        const yearlySlackingDays = document.getElementById('yearlySlackingDays');
        const yearlyMostCommonType = document.getElementById('yearlyMostCommonType');
        const monthlyBreakdownChart = document.getElementById('monthlyBreakdownChart');
        const noYearlyDataText = document.getElementById('noYearlyDataText');
        const noYearSelectedText = document.getElementById('noYearSelectedText');

        const achievementDisplay = document.getElementById('achievementDisplay');
        const achievementIcon = document.getElementById('achievementIcon');
        const achievementName = document.getElementById('achievementName');
        const totalSlackingHoursDisplay = document.getElementById('totalSlackingHoursDisplay');
        const achievementProgressBar = document.getElementById('achievementProgressBar');
        const nextAchievementText = document.getElementById('nextAchievementText');

        // --- State Variables ---
        let appSettings = {
            monthlySalary: null,
            workStartTime: '09:30', 
            workEndTime: '18:30',   
            lunchBreakMinutes: 60, 
            payday: 10, 
            lastAchievedIndex: -1 
        };
        let isSlacking = false;
        let slackingStartTime = null;
        let timerInterval = null;
        let slackingHistory = []; 
        const initialSlackingTypes = [
            "摸鱼群聊天吹水", "刷搞笑短视频", "看八卦新闻", "网上快乐冲浪", "发呆思考人生", "偷偷学习充电", "其他自定义"
        ];
        const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
        
        const achievements = [
            { hours: 1, title: "摸鱼萌新 🌱", icon: "fa-seedling" },
            { hours: 5, title: "摸鱼新手 🎣", icon: "fa-fish" },
            { hours: 10, title: "摸鱼爱好者 🥳", icon: "fa-grin-stars" },
            { hours: 25, title: "摸鱼常客 😎", icon: "fa-user-astronaut" },
            { hours: 50, title: "摸鱼达人 🏆", icon: "fa-trophy" },
            { hours: 100, title: "摸鱼大师 👑", icon: "fa-crown" },
            { hours: 200, title: "摸鱼宗师 🧘", icon: "fa-om" },
            { hours: 500, title: "摸鱼之神 ✨", icon: "fa-meteor" },
            { hours: 1000, title: "摸鱼传说 🌌", icon: "fa-infinity" } 
        ];

        // --- Helper Functions ---
        function formatDuration(ms, mode = 'hms') {
            if (ms <= 0) { 
                return mode === 'hours' ? '0.00' : '00:00:00';
            }
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (mode === 'hours') {
                return (ms / (1000 * 60 * 60)).toFixed(2);
            }
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function showToast(message, duration = 3000) {
            toastMessage.textContent = message;
            toastMessage.classList.add('show', 'initial');
            setTimeout(() => toastMessage.classList.remove('initial'), 10); 
            setTimeout(() => {
                toastMessage.classList.remove('show');
            }, duration);
        }

        function getMillisecondsFromTime(timeStr) { 
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60 + minutes) * 60 * 1000;
        }

        function getWeekdaysInCurrentMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let weekdays = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay(); 
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    weekdays++;
                }
            }
            return weekdays;
        }
        
        function getDaysInMonth(year, month) { 
            return new Date(year, month + 1, 0).getDate();
        }


        // --- Page Navigation Logic ---
        function switchPage(targetPageId) {
            allPageContents.forEach(content => {
                if (content.id === targetPageId) {
                    content.classList.add('active');
                    content.classList.remove('hidden');
                } else {
                    content.classList.remove('active');
                    content.classList.add('hidden');
                }
            });

            if (targetPageId === 'yearlyView') {
                populateYearSelect();
                renderYearlyData();
            }
             if (targetPageId === 'settingsView') { 
                loadSettingsValuesToInputs(); 
            }
            localStorage.setItem('currentPage_moyuriji', targetPageId);
        }

        pageSelect.addEventListener('change', (event) => {
            switchPage(event.target.value);
        });

        monthlySalaryConfigLink.addEventListener('click', () => {
            pageSelect.value = 'settingsView'; 
            switchPage('settingsView');      
        });


        // --- Slacking Type Management ---
        function populateSlackingTypesDropdown() {
            slackingTypeSelect.innerHTML = '';
            initialSlackingTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                slackingTypeSelect.appendChild(option);
            });
            slackingTypeSelect.value = initialSlackingTypes[initialSlackingTypes.length -1];
            if (slackingTypeSelect.value === "其他自定义") {
                 customSlackingTypeDiv.classList.remove('hidden');
            }
        }

        slackingTypeSelect.addEventListener('change', function() {
            if (this.value === "其他自定义") {
                customSlackingTypeDiv.classList.remove('hidden');
                customSlackingTypeInput.focus();
            } else {
                customSlackingTypeDiv.classList.add('hidden');
                customSlackingTypeInput.value = '';
            }
        });

        // --- Settings Management ---
        function loadSettingsValuesToInputs() { 
            monthlySalaryInput.value = appSettings.monthlySalary || '';
            workStartTimeInput.value = appSettings.workStartTime;
            workEndTimeInput.value = appSettings.workEndTime;
            lunchBreakMinutesInput.value = appSettings.lunchBreakMinutes;
            settingsPaydayInput.value = appSettings.payday;
        }
        
        function loadSettings() {
            const storedSettings = localStorage.getItem('appSettings_moyuriji_v2'); 
            if (storedSettings) {
                appSettings = JSON.parse(storedSettings);
                if (appSettings.lunchBreakMinutes === undefined) appSettings.lunchBreakMinutes = 60; 
                if (appSettings.lastAchievedIndex === undefined) appSettings.lastAchievedIndex = -1;
                if (appSettings.payday === undefined) appSettings.payday = 10; 
            }
            loadSettingsValuesToInputs(); 
            updateMonthlySummaryDisplay(); 
            updateAchievementDisplay();    
        }

        function saveSettings() { 
            appSettings.monthlySalary = parseFloat(monthlySalaryInput.value) || null;
            appSettings.workStartTime = workStartTimeInput.value || '09:30';
            appSettings.workEndTime = workEndTimeInput.value || '18:30';
            appSettings.lunchBreakMinutes = parseInt(lunchBreakMinutesInput.value) || 0; 
            if (appSettings.lunchBreakMinutes < 0) appSettings.lunchBreakMinutes = 0;
            
            let paydayValue = parseInt(settingsPaydayInput.value);
            if (isNaN(paydayValue) || paydayValue < 1 || paydayValue > 31) {
                appSettings.payday = 10; 
                settingsPaydayInput.value = 10; 
                showToast('发薪日输入无效，已设为默认10号', 2500);
            } else {
                appSettings.payday = paydayValue;
            }

            localStorage.setItem('appSettings_moyuriji_v2', JSON.stringify(appSettings));
            showToast('✅ 配置已保存! 太棒啦!', 2000);
            updateMonthlySummaryDisplay(); 
        }
        saveSettingsButtonPage.addEventListener('click', saveSettings); 


        // --- Slacking Logic (Main View) ---
        function loadSlackingHistory() {
            const storedHistory = localStorage.getItem('slackingHistory_moyuriji_v1'); 
            if (storedHistory) {
                slackingHistory = JSON.parse(storedHistory);
            }
            renderMonthlyHistory();
            updateMonthlySummaryDisplay();
            updateAchievementDisplay(); 
            populateYearSelect(); 
            renderYearlyData();
        }

        function saveSlackingHistory() {
            localStorage.setItem('slackingHistory_moyuriji_v1', JSON.stringify(slackingHistory));
        }

        function renderMonthlyHistory() { 
            historyList.innerHTML = ''; 
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const monthlyHistory = slackingHistory.filter(item => {
                 const itemDate = new Date(item.startTime);
                 return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
            });

            if (monthlyHistory.length === 0) {
                noHistoryText.style.display = 'block';
                return;
            }
            noHistoryText.style.display = 'none';

            monthlyHistory.slice().reverse().forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 bg-amber-50 rounded-lg border border-amber-200 shadow-sm';
                
                let activityDisplay = `<p class="font-semibold text-orange-700">${item.activityType || '未指定类型'}</p>`;
                // Removed activityNotes display from history
                
                const durationText = formatDuration(item.duration);
                const dateText = new Date(item.startTime).toLocaleString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                itemDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>${activityDisplay}</div>
                        <p class="text-sm text-orange-600 font-bold whitespace-nowrap pl-3">${durationText}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1.5">开始于: ${dateText}</p>
                `;
                historyList.appendChild(itemDiv);
            });
        }

        function updateTimer() {
            if (!isSlacking || !slackingStartTime) return;
            const now = Date.now();
            const elapsed = now - slackingStartTime;
            timerDisplay.textContent = formatDuration(elapsed);
        }
        
        // --- Monthly Summary Calculations & Display ---
        function updateMonthlySummaryDisplay() {
            summaryMonthlySalary.textContent = appSettings.monthlySalary ? `¥ ${appSettings.monthlySalary.toLocaleString()}` : '未设置';

            const dailyWorkStartMs = getMillisecondsFromTime(appSettings.workStartTime);
            const dailyWorkEndMs = getMillisecondsFromTime(appSettings.workEndTime);
            const lunchBreakMs = (appSettings.lunchBreakMinutes || 0) * 60 * 1000; 

            let dailyWorkDurationMs = 0;
            if (appSettings.workStartTime && appSettings.workEndTime && dailyWorkEndMs > dailyWorkStartMs) {
                dailyWorkDurationMs = (dailyWorkEndMs - dailyWorkStartMs) - lunchBreakMs; 
                if (dailyWorkDurationMs < 0) dailyWorkDurationMs = 0; 
                 summaryDailyWorkHours.textContent = `${formatDuration(dailyWorkDurationMs, 'hours')} 小时`;
            } else {
                summaryDailyWorkHours.textContent = '未设置或无效';
            }

            const weekdaysThisMonth = getWeekdaysInCurrentMonth();
            summaryWorkingDays.textContent = `${weekdaysThisMonth} 天`;

            const totalScheduledHours = (dailyWorkDurationMs / (1000 * 60 * 60)) * weekdaysThisMonth;
            summaryTotalScheduledHours.textContent = `${totalScheduledHours.toFixed(2)} 小时`;
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const monthlySlackingMs = slackingHistory
                .filter(item => {
                    const itemDate = new Date(item.startTime);
                    return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
                })
                .reduce((sum, item) => sum + item.duration, 0);
            const monthlySlackingHours = parseFloat(formatDuration(monthlySlackingMs, 'hours'));
            summaryTotalSlackingTime.textContent = `${monthlySlackingHours.toFixed(2)} 小时`;

            const todayDate = today.getDate();
            const payday = appSettings.payday;
            let daysUntilPaydayValue = 0;
            if (payday) {
                if (todayDate <= payday) {
                    daysUntilPaydayValue = payday - todayDate;
                } else {
                    const daysInCurrentM = getDaysInMonth(currentYear, currentMonth);
                    daysUntilPaydayValue = (daysInCurrentM - todayDate) + payday;
                }
                summaryDaysUntilPayday.textContent = `${daysUntilPaydayValue} 天`;
            } else {
                summaryDaysUntilPayday.textContent = '请设置发薪日';
            }

            const productiveHours = totalScheduledHours - monthlySlackingHours;
            let effectiveRate = 0;
            if (appSettings.monthlySalary && productiveHours > 0) {
                effectiveRate = appSettings.monthlySalary / productiveHours;
            }
            const slackedSalaryValue = effectiveRate * monthlySlackingHours;
            summarySlackedSalary.textContent = `¥ ${slackedSalaryValue > 0 ? slackedSalaryValue.toFixed(2) : '0.00'}`;
        }

        // --- Achievement Logic ---
        function getTotalSlackingHours() {
            const totalMs = slackingHistory.reduce((sum, item) => sum + item.duration, 0);
            return parseFloat(formatDuration(totalMs, 'hours'));
        }

        function updateAchievementDisplay() {
            const totalHours = getTotalSlackingHours();
            totalSlackingHoursDisplay.textContent = `总摸鱼时长: ${totalHours.toFixed(2)} 小时`;

            let currentAchievement = { title: "摸鱼初心者 🌱", icon: "fa-seedling", hours: 0 }; 
            let nextAchievement = achievements[0];
            let achievedIndex = -1;

            for (let i = 0; i < achievements.length; i++) {
                if (totalHours >= achievements[i].hours) {
                    currentAchievement = achievements[i];
                    achievedIndex = i;
                } else {
                    nextAchievement = achievements[i];
                    break; 
                }
                if (i === achievements.length - 1 && totalHours >= achievements[i].hours) {
                    nextAchievement = null; 
                }
            }
            
            achievementName.textContent = currentAchievement.title;
            achievementIcon.className = `fas ${currentAchievement.icon} achievement-icon`; 

            if (achievedIndex > appSettings.lastAchievedIndex && achievedIndex !== -1) { 
                showToast(`🎉 恭喜！荣获新称号: ${currentAchievement.title}！`, 5000);
                appSettings.lastAchievedIndex = achievedIndex;
                localStorage.setItem('appSettings_moyuriji_v2', JSON.stringify(appSettings)); 
            }

            if (nextAchievement) {
                const hoursNeededForNext = nextAchievement.hours - totalHours;
                const progressPercentage = Math.min(100, (totalHours / nextAchievement.hours) * 100);
                achievementProgressBar.style.width = `${progressPercentage}%`;
                achievementProgressBar.textContent = `${Math.floor(progressPercentage)}%`;
                achievementProgressBar.classList.toggle('full', progressPercentage >= 100);
                nextAchievementText.textContent = `距离 "${nextAchievement.title}" 还差 ${hoursNeededForNext.toFixed(2)} 小时`;
            } else { 
                achievementProgressBar.style.width = '100%';
                achievementProgressBar.textContent = '已是巅峰！';
                achievementProgressBar.classList.add('full');
                nextAchievementText.textContent = "您已是摸鱼界的传说！ 🌌";
            }
        }

        // --- Yearly Data Logic ---
        function getUniqueYearsFromHistory() {
            const years = new Set();
            slackingHistory.forEach(item => {
                years.add(new Date(item.startTime).getFullYear());
            });
            return Array.from(years).sort((a, b) => b - a); 
        }

        function populateYearSelect() {
            const uniqueYears = getUniqueYearsFromHistory();
            const currentSelectedYear = yearSelectElement.value; 
            yearSelectElement.innerHTML = '<option value="">-- 年份 --</option>'; 
            
            if (uniqueYears.length === 0) {
                 yearlyStatsContainer.classList.add('hidden');
                 noYearSelectedText.textContent = '还没有历史数据，快去摸鱼吧！🐠';
                 noYearSelectedText.classList.remove('hidden');
                 return;
            }

            uniqueYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelectElement.appendChild(option);
            });
            if (uniqueYears.includes(parseInt(currentSelectedYear))) {
                yearSelectElement.value = currentSelectedYear;
            } else if (uniqueYears.length > 0) {
                 yearSelectElement.value = uniqueYears[0]; 
            }
        }

        yearSelectElement.addEventListener('change', renderYearlyData); 

        function renderYearlyData() {
            const selectedYear = parseInt(yearSelectElement.value); 
            if (!selectedYear) {
                yearlyStatsContainer.classList.add('hidden');
                noYearSelectedText.classList.remove('hidden');
                noYearSelectedText.textContent = '请先选择一个年份查看你的摸鱼成就吧！✨';
                return;
            }
            
            noYearSelectedText.classList.add('hidden');
            yearlyStatsContainer.classList.remove('hidden');

            const yearlyData = slackingHistory.filter(item => new Date(item.startTime).getFullYear() === selectedYear);

            if (yearlyData.length === 0) {
                yearlyTotalSlackingTime.textContent = '0.00 小时';
                yearlySlackingDays.textContent = '0 天';
                yearlyMostCommonType.textContent = '-';
                monthlyBreakdownChart.innerHTML = ''; 
                noYearlyDataText.classList.remove('hidden'); 
                return;
            }
            noYearlyDataText.classList.add('hidden'); 

            const totalMs = yearlyData.reduce((sum, item) => sum + item.duration, 0);
            yearlyTotalSlackingTime.textContent = `${formatDuration(totalMs, 'hours')} 小时`;

            const slackingDaysSet = new Set();
            yearlyData.forEach(item => {
                const date = new Date(item.startTime);
                slackingDaysSet.add(`${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`);
            });
            yearlySlackingDays.textContent = `${slackingDaysSet.size} 天`;

            const typeCounts = {};
            yearlyData.forEach(item => {
                typeCounts[item.activityType] = (typeCounts[item.activityType] || 0) + 1;
            });
            let maxCount = 0;
            let commonType = '-';
            for (const type in typeCounts) {
                if (typeCounts[type] > maxCount) {
                    maxCount = typeCounts[type];
                    commonType = type;
                }
            }
            yearlyMostCommonType.textContent = commonType;

            const monthlySlacking = Array(12).fill(0); 
            yearlyData.forEach(item => {
                const month = new Date(item.startTime).getMonth(); 
                monthlySlacking[month] += item.duration;
            });

            monthlyBreakdownChart.innerHTML = ''; 
            let maxMonthlyMs = Math.max(...monthlySlacking);
            if (maxMonthlyMs === 0) maxMonthlyMs = 1; 

            monthlySlacking.forEach((ms, index) => {
                const hours = parseFloat(formatDuration(ms, 'hours'));
                const barWidthPercentage = (ms / maxMonthlyMs) * 100;
                
                const monthDiv = document.createElement('div');
                monthDiv.className = 'flex items-center mb-1.5';
                monthDiv.innerHTML = `
                    <span class="chart-label text-sm text-gray-600">${monthNames[index]}:</span>
                    <div class="chart-container">
                        <div class="chart-bar h-full" style="width: ${barWidthPercentage}%;" title="${hours.toFixed(2)} 小时">${hours > 0 ? hours.toFixed(1) + 'h' : ''}</div>
                    </div>
                `;
                monthlyBreakdownChart.appendChild(monthDiv);
            });
        }

        // --- Event Listeners (Main View) ---
        toggleButton.addEventListener('click', () => {
            isSlacking = !isSlacking;
            if (isSlacking) {
                slackingStartTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
                toggleButton.innerHTML = `<i class="fas fa-stop-circle icon-sm"></i> 结束摸鱼`;
                toggleButton.classList.remove('btn-primary');
                toggleButton.classList.add('btn-danger');
                statusText.textContent = '当前状态：快乐摸鱼中... 🐠';
                // activityNotesInput.disabled = true; // Removed
                slackingTypeSelect.disabled = true;
                customSlackingTypeInput.disabled = true;
                showToast('🐟 摸鱼开始！祝你摸得开心～', 2000);
            } else {
                clearInterval(timerInterval);
                const endTime = Date.now();
                const duration = endTime - slackingStartTime;
                
                if (duration > 1000) { 
                    let activityType = slackingTypeSelect.value;
                    if (activityType === "其他自定义") { 
                        activityType = customSlackingTypeInput.value.trim() || "神秘摸鱼法";
                    }

                    slackingHistory.push({
                        startTime: slackingStartTime,
                        endTime: endTime,
                        duration: duration,
                        activityType: activityType
                        // activityNotes: activityNotesInput.value.trim() // Removed
                    });
                    saveSlackingHistory();
                    renderMonthlyHistory(); 
                    updateMonthlySummaryDisplay(); 
                    updateAchievementDisplay(); 
                    populateYearSelect();
                    renderYearlyData(); 
                }
                
                timerDisplay.textContent = '00:00:00';
                toggleButton.innerHTML = `<i class="fas fa-paper-plane icon-sm"></i> 开启摸鱼之旅!`;
                toggleButton.classList.remove('btn-danger');
                toggleButton.classList.add('btn-primary');
                statusText.textContent = '当前状态：元气满满 💪';
                
                // activityNotesInput.value = ''; // Removed
                // activityNotesInput.disabled = false; // Removed
                slackingTypeSelect.disabled = false;
                customSlackingTypeInput.value = '';
                customSlackingTypeInput.disabled = false;
                
                slackingTypeSelect.value = initialSlackingTypes[initialSlackingTypes.length -1];
                if (slackingTypeSelect.value === "其他自定义") {
                    customSlackingTypeDiv.classList.remove('hidden');
                } else {
                    customSlackingTypeDiv.classList.add('hidden');
                }

                slackingStartTime = null;
                showToast('🎣 摸鱼结束！记录已保存，继续加油哦！', 2000);
            }
        });

        clearHistoryButton.addEventListener('click', () => {
            if (slackingHistory.length === 0) {
                showToast('还没有记录，无法清空哦～', 2000);
                return;
            }
            if (confirm('确定要清空所有摸鱼日记吗？回忆会消失的哦～😢')) {
                slackingHistory = [];
                appSettings.lastAchievedIndex = -1; 
                saveSlackingHistory();
                saveSettings(); 
                renderMonthlyHistory(); 
                updateMonthlySummaryDisplay(); 
                updateAchievementDisplay(); 
                populateYearSelect(); 
                renderYearlyData();   
                showToast('所有摸鱼日记已清空！又是新的一天！☀️', 2000);
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            populateSlackingTypesDropdown();
            loadSettings(); 
            loadSlackingHistory(); 
            
            const savedPage = localStorage.getItem('currentPage_moyuriji');
            if (savedPage && document.getElementById(savedPage)) {
                pageSelect.value = savedPage; 
                switchPage(savedPage);
            } else {
                switchPage('mainView'); 
            }
            
            loadSettingsValuesToInputs();


            if (!workStartTimeInput.value && document.getElementById('settingsWorkStartTime')) document.getElementById('settingsWorkStartTime').value = appSettings.workStartTime; 
            if (!workEndTimeInput.value && document.getElementById('settingsWorkEndTime')) document.getElementById('settingsWorkEndTime').value = appSettings.workEndTime;   
            if (!lunchBreakMinutesInput.value && document.getElementById('settingsLunchBreakMinutes')) document.getElementById('settingsLunchBreakMinutes').value = appSettings.lunchBreakMinutes; 
            if (!settingsPaydayInput.value && document.getElementById('settingsPayday')) document.getElementById('settingsPayday').value = appSettings.payday;


            if (slackingTypeSelect.value !== "其他自定义") {
                 customSlackingTypeDiv.classList.add('hidden');
            } else {
                 customSlackingTypeDiv.classList.remove('hidden'); 
            }
        });

    </script>
</body>
</html>
